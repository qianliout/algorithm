# Go 速率限制（Rate Limiter）完全指南 (修正版)

本文根据反馈进行了修正和补充，将深入探讨速率限制的原理、多种实现算法，并聚焦于**对每个用户进行独立限流**的场景，提供在 Go 中实现单机和分布式速率限制的详细步骤和代码，特别是新增了使用 Redis ZSET 的精确滑动窗口方案。

## 1. 什么是速率限制 (Rate Limiting)？

速率限制是一种用于控制在单位时间内，特定操作（如 API 请求、函数调用）执行次数的机制。它像是系统入口的一个“安检员”，确保进入系统的流量在可控范围内。

**核心目的：**

*   **保障系统稳定与可用性**：防止因瞬间流量洪峰（如秒杀活动、爬虫、恶意攻击）导致服务过载、响应缓慢甚至崩溃。
*   **防止资源滥用**：避免恶意用户或程序通过大量请求耗尽服务器资源（CPU、内存、带宽），确保服务的正常运行。
*   **保证服务公平性**：确保所有用户都能公平地访问服务，防止个别“重度”用户挤占过多资源，影响其他用户的体验。
*   **成本控制**：对于依赖第三方 API 或按量计费的云服务，速率限制可以精确控制调用频率，避免产生预期之外的费用。

---

## 2. 常见的速率限制算法

理解核心算法是实现一个高效限流器的基础。

### a. 令牌桶 (Token Bucket) - 主流之选

这是最流行、应用最广泛的算法，Go 的官方扩展包 `golang.org/x/time/rate` 就是基于此算法实现的。

*   **原理**：
    1.  有一个固定容量的“桶”，系统以恒定的速率往桶里放入“令牌”。
    2.  如果桶满了，多余的令牌会被丢弃。
    3.  每次请求需要从桶里获取一个令牌才能被处理。
    4.  如果桶是空的，没有可用令牌，那么请求将被拒绝或进入等待队列。

*   **特点**：
    *   **允许突发流量**：当桶里有累积的令牌时，系统可以一次性处理掉多个请求，直到令牌耗尽。这对于处理突发性的流量非常友好。
    *   **控制平均速率**：从长远来看，请求的处理速率受限于令牌的生成速率。

### b. 漏桶 (Leaky Bucket)

*   **原理**：
    1.  请求像水一样进入一个固定容量的“桶”。
    2.  桶底有一个“漏孔”，以恒定的速率处理请求（让水流出）。
    3.  如果水进入的速度大于流出的速度，桶里的水会逐渐增多。
    4.  如果桶满了，新来的请求（水）将溢出，即被丢弃。

*   **特点**：
    *   **强制平滑流量**：无论进入的流量有多么汹涌，出口的速率永远是恒定的。这可以强制性地保护后端服务。
    *   **无法处理突发流量**：即使系统处于空闲状态，也无法加速处理突发的请求。

### c. 固定窗口计数器 (Fixed Window Counter)

*   **原理**：
    1.  将时间划分为固定的窗口，例如，每秒一个窗口。
    2.  在每个窗口内，维护一个计数器，记录该窗口接收到的请求数。
    3.  如果计数器超过了限制，则该窗口内的后续请求都会被拒绝。
    4.  时间进入下一个窗口时，计数器重置为 0。

*   **特点**：
    *   **实现简单**：非常容易理解和实现。
    *   **临界问题 (Boundary Problem)**：在窗口的边界处，流量可能失控。例如，限制是“每秒5个请求”。如果在 `00:00:00.500` 到 `00:00:01.000` 之间来了5个请求，又在 `00:00:01.000` 到 `00:00:01.500` 之间来了5个请求，那么在这一秒的真实时间里，系统实际处理了10个请求，是限制的两倍。

### d. 滑动窗口（Sliding Window）

滑动窗口算法是对固定窗口的改进，旨在解决临界问题。

*   **滑动窗口日志 (Sliding Window Log)**：
    *   **原理**：记录每个请求的精确时间戳。当新请求到来时，移除时间窗口之外的所有旧时间戳，然后计算窗口内的时间戳数量。如果数量小于阈值，则接受请求。
    *   **特点**：非常精确，但需要为每个请求存储时间戳，当流量巨大时内存开销也很大。

*   **滑动窗口计数器 (Sliding Window Counter)**：
    *   **原理**：一种工程上的折中方案。它将一个大窗口（如1分钟）分割成多个小格子（如6个10秒的格子）。每当请求到来，当前格子计数器加一。总请求数是当前格子和前5个格子的计数器之和。窗口随着时间滑动。
    *   **特点**：在精度和资源消耗之间取得了很好的平衡，是分布式限流中非常实用的方案。